@page "/management/exams"
@using System.Text
@using System.IO
@using Microsoft.AspNetCore.Components.Sections
@using X39.Software.ExamMaker.Models
@using X39.Software.ExamMaker.WebApp.Services
@using X39.Software.ExamMaker.WebApp.Services.ExamRepository
@inject NavigationManager NavigationManager
@inject BaseUrl BaseUrl
@inject IExamRepository ExamRepository
@inject CsvService CsvService
@inject JsUtil JsUtil
@inject JwtAuthenticationStateProvider JwtAuthenticationStateProvider

<SectionContent SectionName="@MainLayout.FooterStartSectionOutlet">
    <FluentToolbar>
        <FluentButton Appearance="Appearance.Accent" onclick="@(async () => await CreateAndOpenExamAsync())">
            @Localizer[nameof(Language.Pages_Management_Exams_All_Index_ToolBar_CreateAndOpenNewExam)]
        </FluentButton>
        <FluentInputFile Id="csv-import"
                         Multiple="false"
                         MaximumFileCount="1"
                         Accept=".csv"
                         OnCompleted="@OnImportCsvCompletedAsync"
                         Style="display: none;"/>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => JsUtil.ClickAsync("csv-import"))">
            @Localizer[nameof(Language.Pages_Management_Exams_All_Index_ToolBar_ImportFromCsv)]
        </FluentButton>
    </FluentToolbar>
</SectionContent>

<FluentDataGrid TGridItem="ExamListingDto" ItemsProvider="ProvideItemsAsync" RowSize="DataGridRowSize.Large" ItemSize="45">
    <PropertyColumn Title="@Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridHeaders_CreatedAt)]"
                    Property="@(e => e.CreatedAt)"
                    Sortable="false"/>
    <PropertyColumn Title="@Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridHeaders_Title)]"
                    Property="@(e => e.Title)"
                    Sortable="false"/>
    <PropertyColumn Title="@Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridHeaders_Identifier)]"
                    Property="@(e => e.Identifier)"
                    Sortable="false"/>
    <TemplateColumn Title="@Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridHeaders_Operations)]">
        <FluentButton Appearance="Appearance.Accent" OnClick="@(() => OpenExamAsync(context.Identifier))">
            @Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridOperation_OpenExam)]
        </FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="@(() => DownloadExamPdfAsync(context))">
            @Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridOperation_DownloadAsPdf)]
        </FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="@(() => ExportToCsvAsync(context))">
            @Localizer[nameof(Language.Pages_Management_Exams_All_Index_GridOperation_ExportToCsv)]
        </FluentButton>
    </TemplateColumn>
</FluentDataGrid>

@code {
    private int? _totalItemCount;

    private async ValueTask<GridItemsProviderResult<ExamListingDto>> ProvideItemsAsync(GridItemsProviderRequest<ExamListingDto> request)
    {
        _totalItemCount ??= (int) await ExamRepository.GetAllCountAsync(request.CancellationToken);

        var items = await ExamRepository.GetAllAsync(request.StartIndex, request.Count ?? 20, request.CancellationToken);

        return new GridItemsProviderResult<ExamListingDto>
        {
            TotalItemCount = _totalItemCount.Value,
            Items          = items.ToArray(),
        };
    }

    private void OpenExamAsync(Guid? identifier)
    {
        if (identifier is null)
            return;
        NavigationManager.NavigateTo(BaseUrl.ResolveSelfUrl($"/management/exams/{identifier}"));
    }

    private async Task CreateAndOpenExamAsync()
    {
        // ToDo: Improve user experience, using toasts during and after creation and on error + busy hints
        var guid = Guid.NewGuid();
        await ExamRepository.UpdateAsync(guid, string.Empty, string.Empty, string.Empty);
        OpenExamAsync(guid);
    }

    private async Task DownloadExamPdfAsync(ExamListingDto exam)
    {
        var token = await JwtAuthenticationStateProvider.GetTokenAsync();
        if (token is null)
            throw new InvalidOperationException("No JWT token available");

        var url = BaseUrl.ResolveApiUrl($"Exam/{exam.Identifier}/pdf");
        await JsUtil.ApiDownload(url, $"{exam.Title}.pdf", token);
    }

    private async Task OnImportCsvCompletedAsync(IEnumerable<FluentInputFileEventArgs> files)
    {
        var file = files.FirstOrDefault();
        if (file is null) return;

        if (file.Stream is not null)
        {
            using var reader = new StreamReader(file.Stream);
            var content = await reader.ReadToEndAsync();
            await CsvService.ImportAsync(content);
            _totalItemCount = null; // Reset to refresh grid
        }
    }

    private async Task ExportToCsvAsync(ExamListingDto exam)
    {
        var csvContent = await CsvService.ExportAsync(exam.Identifier!.Value);
        await JsUtil.DownloadAsync($"{exam.Title}.csv", "text/csv", csvContent);
    }
}
