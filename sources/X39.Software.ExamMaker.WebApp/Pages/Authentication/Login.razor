@page "/authentication/login"
@using System.ComponentModel.DataAnnotations
@using X39.Software.ExamMaker.WebApp.Components
@using X39.Software.ExamMaker.WebApp.Services
@using X39.Software.ExamMaker.WebApp.Services.UserRepository
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@inject NavigationManager NavigationManager
@inject BaseUrl BaseUrl
@inject IUserRepository UserRepository
@inject IToastService ToastService
@inject ILogger<Login> Logger


<BusyComponent @ref="_busy" Class="container">
    <FluentCard MinimalStyle="true" Class="card">
        <FluentEditForm Model="_model">
            <FluentLabel Typo="Typography.Subject">
                @Localizer[nameof(Language.Pages_Authentication_Login_Card_LoginSubject)]
            </FluentLabel>
            <FluentTextField AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Login_Card_EMailAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Login_Card_EMailLabel)]"
                             TextFieldType="TextFieldType.Email"
                             @bind-Value="@_model.EMail"
                             Minlength="2"
                             Placeholder="email"/>
            <FluentValidationMessage For="@(() => _model.EMail)"/>
            <FluentTextField AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Login_Card_PasswordAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Login_Card_PasswordLabel)]"
                             TextFieldType="TextFieldType.Password"
                             @bind-Value="@_model.Password"
                             Placeholder="password"
                             Minlength="2"/>
            <FluentValidationMessage For="@(() => _model.Password)"/>

            <FluentStack Orientation="Orientation.Horizontal" Class="actions">
                <FluentButton OnClick="OnToRegistrationButtonClickAsync">
                    @Localizer[nameof(Language.Pages_Authentication_Login_Card_ToRegistrationButton)]
                </FluentButton>
                <FluentSpacer/>
                <FluentButton Type="ButtonType.Submit"
                              OnClick="OnLoginButtonClickAsync"
                              Appearance="Appearance.Accent">
                    @Localizer[nameof(Language.Pages_Authentication_Login_Card_LoginButton)]
                </FluentButton>
            </FluentStack>
        </FluentEditForm>
    </FluentCard>
</BusyComponent>

@code {

    private readonly Model         _model = new();
    private          BusyComponent _busy  = null!;

    public sealed class Model
    {
        [EmailAddress]
        public string EMail { get; set; } = string.Empty;

        [MinLength(6)]
        public string Password { get; set; } = string.Empty;
    }

    private async Task OnLoginButtonClickAsync()
    {
        using var busy = _busy.Busy();
        var parameters = new ToastParameters<ProgressToastContent>
        {
            Id      = "pages-authentication-login-toast",
            Content = new ProgressToastContent(),
            Title   = Localizer[nameof(Language.Pages_Authentication_Login_Toast_LoggingIn)],
        };
        ToastService.ShowProgressToast(parameters);
        try
        {
            Logger.LogDebug("Logging in with {EMail}", _model.EMail);
            await UserRepository.LoginAsync(_model.EMail, _model.Password);
            ToastService.ShowSuccess(Localizer[nameof(Language.Pages_Authentication_Login_Toast_LoginSuccessful)]);
            NavigationManager.NavigateTo(BaseUrl.ResolveSelfUrl("/"));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to log in");
            ToastService.ShowError(Localizer[nameof(Language.Pages_Authentication_Login_Toast_LoginFailed)]);
        }
        finally
        {
            ToastService.CloseToast(parameters.Id);
        }
    }

    private Task OnToRegistrationButtonClickAsync()
    {
        NavigationManager.NavigateTo(BaseUrl.ResolveSelfUrl("/authentication/register/organization"));
        return Task.CompletedTask;
    }

}
