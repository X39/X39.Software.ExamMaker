@page "/authentication/register/organization"
@using System.ComponentModel.DataAnnotations
@using X39.Software.ExamMaker.WebApp.Services
@using X39.Software.ExamMaker.WebApp.Services.UserRepository
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@inject NavigationManager NavigationManager
@inject BaseUrl BaseUrl
@inject IUserRepository UserRepository
@inject IToastService ToastService
@inject ILogger<Register> Logger

<BusyComponent @ref="_busy" Class="d-flex flex-column h-100p p-a-1em">
    <FluentCard MinimalStyle="true" Class="w-max-512px m-auto h-auto-bang">
        <FluentEditForm Model="_model">
            <FluentLabel Class="flex-grow-1 m-b-2em" Typo="Typography.Subject">
                @Localizer[nameof(Language.Pages_Authentication_Register_Card_RegisterSubject)]
            </FluentLabel>
            <FluentTextField Class="flex-grow-1"
                             AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Register_Card_OrganizationNameAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Register_Card_OrganizationNameLabel)]"
                             TextFieldType="TextFieldType.Text"
                             @bind-Value="@_model.OrganizationName"
                             Minlength="2"/>
            <FluentValidationMessage For="@(() => _model.EMail)"/>
            <FluentTextField Class="flex-grow-1"
                             AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Register_Card_EMailAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Register_Card_EMailLabel)]"
                             TextFieldType="TextFieldType.Email"
                             @bind-Value="@_model.EMail"
                             Minlength="2"
                             Placeholder="email"/>
            <FluentValidationMessage For="@(() => _model.EMail)"/>
            <FluentTextField Class="flex-grow-1"
                             AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Register_Card_FirstNameAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Register_Card_FirstNameLabel)]"
                             TextFieldType="TextFieldType.Text"
                             @bind-Value="@_model.FirstName"
                             Minlength="2"
                             Placeholder="first name"/>
            <FluentValidationMessage For="@(() => _model.FirstName)"/>
            <FluentTextField Class="flex-grow-1"
                             AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Register_Card_LastNameAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Register_Card_LastNameLabel)]"
                             TextFieldType="TextFieldType.Text"
                             @bind-Value="@_model.LastName"
                             Placeholder="last name"
                             Minlength="2"/>
            <FluentValidationMessage For="@(() => _model.LastName)"/>
            <FluentTextField Class="flex-grow-1"
                             AriaLabel="@Localizer[nameof(Language.Pages_Authentication_Register_Card_PasswordAria)]"
                             Label="@Localizer[nameof(Language.Pages_Authentication_Register_Card_PasswordLabel)]"
                             TextFieldType="TextFieldType.Password"
                             @bind-Value="@_model.Password"
                             Placeholder="password"
                             Minlength="2"/>
            <FluentValidationMessage For="@(() => _model.Password)"/>

            <FluentStack Class="flex-grow-1 m-t-4em" Orientation="Orientation.Horizontal">
                <FluentButton OnClick="OnToLoginClickAsync"
                              Disabled="@_busy.IsBusy">
                    @Localizer[nameof(Language.Pages_Authentication_Register_Card_ToLoginButton)]
                </FluentButton>
                <FluentButton OnClick="OnToRegisterUserClickAsync"
                              Disabled="@_busy.IsBusy">
                    @Localizer[nameof(Language.Pages_Authentication_Register_Card_ToTokenRegistrationButton)]
                </FluentButton>
                <FluentSpacer/>
                <FluentButton Type="ButtonType.Submit"
                              OnClick="OnRegisterButtonClickAsync"
                              Appearance="Appearance.Accent"
                              Disabled="@_busy.IsBusy">
                    @Localizer[nameof(Language.Pages_Authentication_Register_Card_RegisterButton)]
                </FluentButton>
            </FluentStack>
        </FluentEditForm>
    </FluentCard>
</BusyComponent>

@code {

    private readonly Model         _model = new();
    private          BusyComponent _busy  = null!;

    public sealed class Model
    {
        [EmailAddress]
        public string EMail { get; set; } = string.Empty;

        [MinLength(1)]
        public string FirstName { get; set; } = string.Empty;

        [MinLength(1)]
        public string LastName { get; set; } = string.Empty;

        [MinLength(6)]
        public string Password { get; set; } = string.Empty;

        [MinLength(3)]
        public string OrganizationName { get; set; } = string.Empty;
    }

    private Task OnRegisterButtonClickAsync() => _busy.ExclusiveBusyAsync(async () =>
        {
            var parameters = new ToastParameters<ProgressToastContent>
            {
                // Ticks are added as otherwise when the user keeps pressing enter we may end up erroring the UI, due to ToastService limitations
                Id      = $"pages-authentication-register-toast-{DateTime.Now.Ticks}",
                Content = new ProgressToastContent(),
                Title   = Localizer[nameof(Language.Pages_Authentication_Register_Toast_RegisteringNewOrganization)],
            };
            ToastService.ShowProgressToast(parameters);
            try
            {
                await UserRepository.RegisterOrganizationAsync(_model.OrganizationName, _model.EMail, _model.Password, _model.FirstName, _model.LastName);
                await UserRepository.LoginAsync(_model.EMail, _model.Password);
                NavigationManager.NavigateTo(BaseUrl.ResolveSelfUrl("/"));
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to register organization");
                ToastService.ShowError(Localizer[nameof(Language.Pages_Authentication_Register_Toast_RegistrationFailed)]);
            }
            finally
            {
                ToastService.CloseToast(parameters.Id);
            }
        }
    );

    private Task OnToLoginClickAsync()
    {
        NavigationManager.NavigateTo(BaseUrl.ResolveSelfUrl("/authentication/login"));
        return Task.CompletedTask;
    }

    private Task OnToRegisterUserClickAsync()
    {
        NavigationManager.NavigateTo(BaseUrl.ResolveSelfUrl("/authentication/register/user"));
        return Task.CompletedTask;
    }

}
